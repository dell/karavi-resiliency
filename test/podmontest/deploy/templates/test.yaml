apiVersion: v1
kind: ServiceAccount
metadata:
    name: podmontest
    namespace: {{ required "Must set namespace" .Values.podmonTest.namespace }}
---
kind: StatefulSet
apiVersion: apps/v1
metadata:
    name: podmontest
    namespace: {{ required "Must set namespace" .Values.podmonTest.namespace }}
spec:
    selector:
        matchLabels:
          app: podmontest
    serviceName: 2vols
    template:
      metadata:
        labels:
          app: podmontest
          podmon.dellemc.com/driver: {{ required "Must set driver label" .Values.podmonTest.driverLabel }}
      spec:
{{- if ne .Values.podmonTest.zone "" }}
        affinity:
          nodeAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              nodeSelectorTerms:
              - matchExpressions:
                - key: "failure-domain.beta.kubernetes.io/zone"
                  operator: In
                  values: 
                  - {{.Values.podmonTest.zone}}
{{end}}
        serviceAccount: podmontest
        containers:
          - name: podmontest
            image: {{ required "Must set image for podmonTest" .Values.podmonTest.image }}
            imagePullPolicy: IfNotPresent
            command: [ "/podmontest" ]
            args:
              - "-doexit=true"
            env:
              - name: ROOT_DIR
                value: "/"
            volumeMounts:
{{- range $i, $e := untilStep 0 (int .Values.podmonTest.nvolumes) 1 }}
              - mountPath: /data{{$i}}
                name: pvol{{$i}}
{{end}}
            volumeDevices:
{{- range $i, $e := untilStep 0 (int .Values.podmonTest.ndevices) 1 }}
              - devicePath: /blockdata1{{$i}}
                name: pdev{{$i}}
{{end}}
        volumes:
{{- range $i, $e := untilStep 0 (int .Values.podmonTest.nvolumes) 1 }}
          - name: pvol{{$i}}
            persistentVolumeClaim:
              claimName: pvol{{$i}}
{{end}}
{{- range $i, $e := untilStep 0 (int .Values.podmonTest.ndevices) 1 }}
          - name: pdev{{$i}}
            persistentVolumeClaim:
              claimName: pdev{{$i}}
{{end}}
